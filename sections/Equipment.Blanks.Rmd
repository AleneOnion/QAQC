---
title: "Equipment.Blanks"
author: "Alene Onion"
date: "December 29, 2018"
output:
  html_document:
    toc: true
    toc_depth: 6
    toc_float: true
---

```{r setupE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#file.copy("sections/images", ".", recursive = TRUE)
```


##Equipment Blanks

* Equipment Blank exceedances  (result > reporting limit)  
    + Step 1: identify a reporting limit based on the data collected in 2017+18
    + Step 2: pull EB values that exceed these reporting limits
    + Step 3: flag sample values associated with EB exceedences that are less than 10x (flagged calculated), 5x (flagged trend), and 3x (rejected) the equipment blank value   

IT'S IMPORTANT TO NOTE: that the quantitation limit is NOT the reporting limit. It is set by the lab and can vary week to week (the method detection limit can as well). The reporting limit is the project goal (including field and lab errors) and the quantitation limit is what the lab alone achieved. It's important to develop reporting limits specific to the needs of the project. For example, you may have a stricter reporting limit for a track down study than you would have for a screening survey.      

These flags and their thresholds are again taken from OHIO EPA methods (https://www.epa.ohio.gov/portals/35/documents/sw_samplingmanual.pdf). Their detailed description is replicated below:  
```{r, echo=FALSE}
OHIO<-read.csv("data/Ohio.Qualifiers.csv")
knitr::kable(OHIO)
rm(OHIO)
```

###plots    
I only plotted parameters with EB failures.  
The purpose of these plots is to see whether the failures were outliers or were part of an underlying noise. If the latter, then we should consider raising the reporting limit.  
NOTE: I turn non-detects into 0 which I know they are not but for the purpose of identifying failed EBs, I feel this is ok.

```{r message=FALSE, warning=FALSE, results='asis'}
#create pass column - pass if less than reporting limit; reject if more than reporting limit
#convert non-detects to 0
EB$result_value <- ifelse(EB$lab_qualifiers=="U",0,EB$result_value)
EB$result_value <- ifelse(EB$lab_qualifiers=="UN",0,EB$result_value)
EB$result_value <- ifelse(EB$lab_qualifiers=="UE",0,EB$result_value)

#create pass column
EB$pass<-ifelse(EB$result_value>EB$reporting_limit,"fail","pass")
#format date
EB$sample_date <- as.Date(EB$sample_date,"%m/%d/%Y")
```

```{r message=FALSE, warning=FALSE, results='asis'}
#plot the EBt result value / day for each param 
#pull only those parameters with failures
params<-EB[EB$pass!="pass",]
params<-unique(params$chemical_name)
nparams<-length(params)

for(i in 1:nparams){
  temp<-EB[EB$chemical_name==params[i],]
  temp$sample_date<-as.Date(temp$sample_date,"%m/%d/%Y")
  reporting<-temp$reporting_limit[1]
  #plot the result values
  plot(temp$sample_date,temp$result_value,type="p",lwd=4,col="black",main=params[i],xlab="date",ylab="equipment blank result value")
  abline(h=c(reporting))
  rm(list=c('temp','reporting'))
}
rm(list=c('params','nparams','i'))
```

###Rejected Samples
```{r, echo=FALSE}
#truncate the EB file
EBs<-unique(EB[c('chemical_name','result_value','sample_date','pass')])
names(EBs)[names(EBs)=='result_value']<-'blank'
EBs$blank<-ifelse(EBs$pass=="fail",EBs$blank,NA)
EBs$sample_date<-as.Date(EBs$sample_date,"%m/%d/%Y")
EBs<-unique(EBs[c('chemical_name','blank','sample_date')])

samples<-unique(wallkill[c('sys_sample_code','chemical_name','sample_date')])
samples$sample_date<-as.Date(samples$sample_date,"%m/%d/%Y")

params<-unique(EBs$chemical_name)
nparams<-length(params)

for(i in 1:nparams){
  temp<-samples[samples$chemical_name==params[i],]
  tempb<-EBs[EBs$chemical_name==params[i],]
  tempb$sample_date<-as.Date(tempb$sample_date,"%m/%d/%Y")
  sites<-unique(temp$sys_sample_code)
  nsites<-length(sites)
  for(j in 1:nsites){
    temp1<-temp[temp$sys_sample_code==sites[j],]
    temp1$sample_date<-as.Date(temp1$sample_date,"%m/%d/%Y")
    tempb1<-tempb[which(abs(tempb$sample_date-temp1$sample_date)==min(abs(tempb$sample_date-temp1$sample_date))),]
    temp1$blank<-tempb1$blank[1]
    if(exists("dataset")){
      dataset<-merge(dataset,temp1,all=TRUE)
    }
    if(!exists("dataset")){
      dataset<-temp1
    }
    rm(list=c('temp1','tempb1'))
  }
  rm(list=c('temp','tempb','sites','nsites','j'))
}
rm(list=c('params','nparams','i','samples','EBs'))

#merge with final wallkill dataset
#first convert wallkill date to a date
wallkill$sample_date<-as.Date(wallkill$sample_date,"%m/%d/%Y")
wallkill<-merge(wallkill,dataset,by=c('sys_sample_code','chemical_name','sample_date'),all=TRUE)
wallkill<-wallkill[!is.na(wallkill$chemical_name),]
rm(dataset)

#finally, calculate error flag if any
wallkill$EBpass<-ifelse(is.na(wallkill$blank),"A",ifelse(wallkill$result_value<=3*(wallkill$blank),"R",ifelse(wallkill$result_value<=5*(wallkill$blank),"trend",ifelse(wallkill$result_value<=10*(wallkill$blank),"J","A"))))
```

```{r message=FALSE, warning=FALSE, results='asis'}
#plotting the sample failures
#count fails and passes
library(plyr)
blankfails<-count(EB[c('short','pass')])
samplefails<-count(wallkill[c('short','EBpass')])
names(samplefails)[names(samplefails)=='EBpass']<-'legend'
names(blankfails)[names(blankfails)=='pass']<-'legend'
blankfails$legend<-gsub("pass","A",blankfails$legend)
blankfails$legend<-gsub("fail","R",blankfails$legend)

library(ggplot2)
library(ggpubr)
theme_set(theme_pubr())

 samplefails<-(ggplot() +
    geom_col(data=samplefails,aes(short,freq,fill=legend)) +
      coord_flip() +
      theme(axis.title.x = element_blank(),axis.title.y = element_blank()))
 blankfails<-(ggplot() +
    geom_col(data=blankfails,aes(short,freq,fill=legend)) +
      coord_flip() +
      theme(axis.title.x = element_blank(),axis.title.y = element_blank()))
 print(ggarrange(
  samplefails, blankfails, labels = c("associated sample fails", "individual EB fails"),
  common.legend = TRUE, legend = "bottom"
  ))
 rm(list=c('blankfails','samplefails'))
 rm(EB)
```